# For full config options, check the docs: docs.serverless.com

service: ${opt:instanceId}-oidc-provider  

provider:
  name: aws
  runtime: nodejs6.10
  memorySize: 128
  timeout: 15 # Avoid cold start timeouts.
  region: eu-central-1 # Frankfurt
  stage: ${opt:stage}
  cfLogs: true
  deploymentBucket:
    name: ${opt:aws-profile}.${self:provider.region}.sls-deploy
  iamRoleStatements:
    - Effect: Allow
      Action:
        - dynamodb:Query
        - dynamodb:GetItem
        - dynamodb:PutItem
        - dynamodb:UpdateItem
        - dynamodb:DeleteItem
      Resource: arn:aws:dynamodb:${self:provider.region}:*:table/${opt:instanceId}.*

  environment:
    ACCESS_TOKENS_TABLE_NAME: ${self:custom.accessTokensTableName}
    AUTHORIZATION_CODES_TABLE_NAME: ${self:custom.authorizationCodesTableName}
    CLIENT_CREDENTIALS_TABLE_NAME: ${self:custom.clientCredentialsTableName}
    REFRESH_TOKENS_TABLE_NAME: ${self:custom.refreshTokensTableName}
    SESSIONS_TABLE_NAME: ${self:custom.sessionsTableName}
    CLIENTS_TABLE_NAME: ${self:custom.clientsTableName}
    INITIAL_ACCESS_TOKENS_TABLE_NAME: ${self:custom.initialAccessTokensTableName}
    REGISTRATION_ACCESS_TOKENS_TABLE_NAME: ${self:custom.registrationAccessTokensTableName}
    COOKIE_KEYS: "currentsecret,previoussecret" # This is just for the sake of example - the secrets should not be kept her in config, and should be rotated over time - e.g. by a scheduled lambda.
    AWS_PROFILE: ${opt:aws-profile}
    AWS_REGION: ${self:provider.region}

functions:
  main:
    environment:
      DEBUG: oidc-provider:*

    handler: src/index.handler

    events:
      - http: ANY {proxy+}

plugins:
  - serverless-offline
  - serverless-plugin-include-dependencies
  # DynamoDB Auto Scaling is disabled since it seems to cause problems from time to time.
  # - serverless-dynamodb-autoscaling

  
custom:
  accessTokensTableName: ${opt:instanceId}.AccessTokens
  authorizationCodesTableName: ${opt:instanceId}.AuthorizationCodes
  clientCredentialsTableName: ${opt:instanceId}.ClientCredentials
  refreshTokensTableName: ${opt:instanceId}.RefreshTokens
  sessionsTableName: ${opt:instanceId}.Sessions
  clientsTableName: ${opt:instanceId}.Clients
  initialAccessTokensTableName: ${opt:instanceId}.InitialAccessTokens
  registrationAccessTokensTableName: ${opt:instanceId}.RegistrationAccessTokens
  # issuerDomain: ${opt:issuerDomain}


  # defaultCapacities:
  #   minimum: 1
  #   maximum: 5
  #   usage: 0.7

  # capacities:
  #   - table: sessionsTable
  #     read: ${self:custom.defaultCapacities}
  #     write: ${self:custom.defaultCapacities}
  #   - table: accessTokensTable
  #     read: ${self:custom.defaultCapacities}
  #     write: ${self:custom.defaultCapacities}
  #   - table: authorizationCodesTable
  #     read: ${self:custom.defaultCapacities}
  #     write: ${self:custom.defaultCapacities}
  #   - table: refreshTokensTable
  #     read: ${self:custom.defaultCapacities}
  #     write: ${self:custom.defaultCapacities}
  #   - table: clientCredentialsTable
  #     read: ${self:custom.defaultCapacities}
  #     write: ${self:custom.defaultCapacities}
  #   - table: clientsTable
  #     read: ${self:custom.defaultCapacities}
  #     write: ${self:custom.defaultCapacities}
  #   - table: initialAccessTokensTable
  #     read: ${self:custom.defaultCapacities}
  #     write: ${self:custom.defaultCapacities}
  #   - table: registrationAccessTokensTable
  #     read: ${self:custom.defaultCapacities}
  #     write: ${self:custom.defaultCapacities}


defaultTable: &tableDefault
  Type: AWS::DynamoDB::Table
  DeletionPolicy: Retain
  Properties: &tablePropertiesDefault
    AttributeDefinitions:
      -
        AttributeName: id
        AttributeType: S
    KeySchema:
      -
        AttributeName: id
        KeyType: HASH
    ProvisionedThroughput:
      ReadCapacityUnits: 1
      WriteCapacityUnits: 1

ttlTablePropertiesDefault: &ttlTablePropertiesDefault
  <<: *tablePropertiesDefault
  # TODO: Enable TTL after initial testing!!
  # TimeToLiveSpecification:
  #   AttributeName: expiresAt
  #   Enabled: true

grantTablePropertiesDefault: &grantTablePropertiesDefault
  <<: *ttlTablePropertiesDefault
  AttributeDefinitions:
    -
      AttributeName: id
      AttributeType: S
    -
      AttributeName: grantId
      AttributeType: S
  GlobalSecondaryIndexes:
    -
      IndexName: grantId-index
      KeySchema:
        -
          AttributeName: grantId
          KeyType: HASH
      Projection:
        ProjectionType: KEYS_ONLY
      ProvisionedThroughput:
        ReadCapacityUnits: 1
        WriteCapacityUnits: 1

resources:
  Resources:
    sessionsTable:
      <<: *tableDefault
      Properties:
        <<: *ttlTablePropertiesDefault # CHECK: is there an expiresAt field here?
        TableName: ${self:custom.sessionsTableName}

    accessTokensTable:
      <<: *tableDefault
      Properties:
        <<: *grantTablePropertiesDefault
        TableName: ${self:custom.accessTokensTableName}

    authorizationCodesTable:
      <<: *tableDefault
      Properties:
        <<: *grantTablePropertiesDefault
        TableName: ${self:custom.authorizationCodesTableName}

    refreshTokensTable:
      <<: *tableDefault
      Properties:
        <<: *grantTablePropertiesDefault
        TableName: ${self:custom.refreshTokensTableName}

    clientCredentialsTable:
      <<: *tableDefault
      Properties:
        <<: *tablePropertiesDefault
        TableName: ${self:custom.clientCredentialsTableName}

    clientsTable:
      <<: *tableDefault
      Properties:
        <<: *tablePropertiesDefault
        TableName: ${self:custom.clientsTableName}

    initialAccessTokensTable:
      <<: *tableDefault
      Properties:
        <<: *ttlTablePropertiesDefault
        TableName: ${self:custom.initialAccessTokensTableName}

    registrationAccessTokensTable:
      <<: *tableDefault
      Properties:
        <<: *ttlTablePropertiesDefault
        TableName: ${self:custom.registrationAccessTokensTableName}


    # Path Mapping is disabled since it seems to cause problems from time to time.
    # pathmapping:
    #   Type: AWS::ApiGateway::BasePathMapping
    #   Properties:
    #     DomainName: ${self:custom.issuerDomain} # Must already be registered as a custom domain !
    #     RestApiId:
    #       Ref: ApiGatewayRestApi
    #     Stage: ${self:provider.stage}

