service: ${opt:instanceId}-op

custom:
  accessTokensTableName: ${opt:instanceId}.AccessTokens
  authorizationCodesTableName: ${opt:instanceId}.AuthorizationCodes
  clientCredentialsTableName: ${opt:instanceId}.ClientCredentials
  refreshTokensTableName: ${opt:instanceId}.RefreshTokens
  sessionsTableName: ${opt:instanceId}.Sessions
  clientsTableName: ${opt:instanceId}.Clients
  initialAccessTokensTableName: ${opt:instanceId}.InitialAccessTokens
  registrationAccessTokensTableName: ${opt:instanceId}.RegistrationAccessTokens
  issuerIdentifier: ${opt:issuer}

provider:
  name: aws
  runtime: nodejs6.10
  region: eu-central-1 # Overwrite the default region used. Default is us-east-1
  profile: serverless # The default profile to use with this service
  memorySize: 256 # Overwrite the default memory size. Default is 1024
  timeout: 30
  cfLogs: true
  iamRoleStatements:
    - Effect: Allow
      Action:
        - dynamodb:Query
        - dynamodb:GetItem
        - dynamodb:PutItem
        - dynamodb:UpdateItem
        - dynamodb:DeleteItem
      Resource: arn:aws:dynamodb:${self:provider.region}:*:table/${opt:instanceId}.*

  environment:
    ISSUER: ${self:custom.issuerIdentifier}
    ACCESS_TOKENS_TABLE_NAME: ${self:custom.accessTokensTableName}
    AUTHORIZATION_CODES_TABLE_NAME: ${self:custom.authorizationCodesTableName}
    CLIENT_CREDENTIALS_TABLE_NAME: ${self:custom.clientCredentialsTableName}
    REFRESH_TOKENS_TABLE_NAME: ${self:custom.refreshTokensTableName}
    SESSIONS_TABLE_NAME: ${self:custom.sessionsTableName}
    CLIENTS_TABLE_NAME: ${self:custom.clientsTableName}
    INITIAL_ACCESS_TOKENS_TABLE_NAME: ${self:custom.initialAccessTokensTableName}
    REGISTRATION_ACCESS_TOKENS_TABLE_NAME: ${self:custom.registrationAccessTokensTableName}

functions:
  oidc:
    environment:
      DEBUG: oidc-provider:*
    handler: oidc.server
    events:
      - http:
          method: any
          path: /
          proxy: true
      - http:
          method: any
          path: /{proxy+}
          proxy: true

defaultTable: &tableDefault
  Type: AWS::DynamoDB::Table
  DeletionPolicy: Delete
  Properties: &tablePropertiesDefault
    AttributeDefinitions:
      -
        AttributeName: id
        AttributeType: S
    KeySchema:
      -
        AttributeName: id
        KeyType: HASH
    ProvisionedThroughput:
      ReadCapacityUnits: 1
      WriteCapacityUnits: 1

grantTablePropertiesDefault: &grantTablePropertiesDefault
  <<: *tablePropertiesDefault
  AttributeDefinitions:
    -
      AttributeName: id
      AttributeType: S
    -
      AttributeName: grantId
      AttributeType: S
  GlobalSecondaryIndexes:
    -
      IndexName: grantId-index
      KeySchema:
        -
          AttributeName: grantId
          KeyType: HASH
      Projection:
        ProjectionType: KEYS_ONLY
      ProvisionedThroughput:
        ReadCapacityUnits: 1
        WriteCapacityUnits: 1

resources:
  Resources:
    sessionsTable:
      <<: *tableDefault
      Properties:
        <<: *tablePropertiesDefault
        TableName: ${self:custom.sessionsTableName}

    accessTokensTable:
      <<: *tableDefault
      Properties:
        <<: *grantTablePropertiesDefault
        TableName: ${self:custom.accessTokensTableName}

    authorizationCodesTable:
      <<: *tableDefault
      Properties:
        <<: *grantTablePropertiesDefault
        TableName: ${self:custom.authorizationCodesTableName}

    refreshTokensTable:
      <<: *tableDefault
      Properties:
        <<: *grantTablePropertiesDefault
        TableName: ${self:custom.refreshTokensTableName}

    clientCredentialsTable:
      <<: *tableDefault
      Properties:
        <<: *tablePropertiesDefault
        TableName: ${self:custom.clientCredentialsTableName}

    clientsTable:
      <<: *tableDefault
      Properties:
        <<: *tablePropertiesDefault
        TableName: ${self:custom.clientsTableName}

    initialAccessTokensTable:
      <<: *tableDefault
      Properties:
        <<: *tablePropertiesDefault
        TableName: ${self:custom.initialAccessTokensTableName}

    registrationAccessTokensTable:
      <<: *tableDefault
      Properties:
        <<: *tablePropertiesDefault
        TableName: ${self:custom.registrationAccessTokensTableName}
